<!-- financial/templates/financial/company_detail_integrated.html -->
{% extends 'financial/base.html' %}
{% load financial_filters %}
{% load static %}

{% block title %}{{ company_name }} - ç·åˆåˆ†æ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'core/css/company_detail.css' %}">
{% endblock %}

{% block content %}
<div class="nav-links">
    <a href="{% url 'financial:home' %}">â† æ¤œç´¢ã«æˆ»ã‚‹</a>
</div>

<h1>{{ company_name }}</h1>
<p class="company-code">EDINETã‚³ãƒ¼ãƒ‰: {{ edinet_code }}</p>

{% if error %}
    <div class="error">{{ error }}</div>
{% else %}

<!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="tab-navigation">
    <button class="tab-button active" data-tab="financial-data">è²¡å‹™ãƒ‡ãƒ¼ã‚¿</button>
    <button class="tab-button" data-tab="ai-analysis">AIä¼æ¥­åˆ†æ</button>
</div>

<!-- è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚¿ãƒ– -->
<div id="financial-data" class="tab-content active">
    <h2>è²¡å‹™ãƒ‡ãƒ¼ã‚¿æ¨ç§»</h2>
    <table>
        <thead>
            <tr>
                <th>å¹´åº¦</th>
                <th>å£²ä¸Šé«˜</th>
                <th>å–¶æ¥­åˆ©ç›Š</th>
                <th>ç´”åˆ©ç›Š</th>
                <th>ç·è³‡ç”£</th>
                <th>ç´”è³‡ç”£</th>
                <th>ROE</th>
                <th>ROA</th>
                <th>è‡ªå·±è³‡æœ¬æ¯”ç‡</th>
            </tr>
        </thead>
        <tbody>
            {% for item in financial_data %}
            <tr>
                <td>{{ item.data.fiscal_year }}å¹´</td>
                <td>
                    {% if item.data.net_sales %}
                        {{ item.data.net_sales|to_billion|floatformat:1 }}å„„å††
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.data.operating_income %}
                        {{ item.data.operating_income|to_billion|floatformat:1 }}å„„å††
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.data.net_income %}
                        {{ item.data.net_income|to_billion|floatformat:1 }}å„„å††
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.data.total_assets %}
                        {{ item.data.total_assets|to_billion|floatformat:1 }}å„„å††
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.data.net_assets %}
                        {{ item.data.net_assets|to_billion|floatformat:1 }}å„„å††
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.indicators.roe %}
                        {{ item.indicators.roe|percentage }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.indicators.roa %}
                        {{ item.indicators.roa|percentage }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.indicators.equity_ratio %}
                        {{ item.indicators.equity_ratio|percentage }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- æˆé•·ç‡ã‚µãƒãƒªãƒ¼ -->
    {% if financial_data|length > 1 %}
    <div class="growth-summary">
        <h3>ç›´è¿‘ã®æˆé•·ç‡</h3>
        {% with latest=financial_data.0.data prev=financial_data.1.data %}
        <div class="growth-metrics">
            {% if latest.net_sales and prev.net_sales %}
            <div class="metric-card">
                <span class="metric-label">å£²ä¸Šé«˜æˆé•·ç‡</span>
                <span class="metric-value {% if latest.net_sales > prev.net_sales %}positive{% else %}negative{% endif %}">
                    {{ latest.net_sales|sub:prev.net_sales|div:prev.net_sales|mul:100|floatformat:1 }}%
                </span>
            </div>
            {% endif %}
            {% if latest.net_income and prev.net_income and prev.net_income != 0 %}
            <div class="metric-card">
                <span class="metric-label">ç´”åˆ©ç›Šæˆé•·ç‡</span>
                <span class="metric-value {% if latest.net_income > prev.net_income %}positive{% else %}negative{% endif %}">
                    {{ latest.net_income|sub:prev.net_income|div:prev.net_income|mul:100|floatformat:1 }}%
                </span>
            </div>
            {% endif %}
        </div>
        {% endwith %}
    </div>
    {% endif %}
    
    <!-- è²¡å‹™åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    {% if financial_data|length > 1 %}
    <div class="financial-analysis-section">
        <h3>ä¼æ¥­ã®ç‰¹å¾´ãƒ»è²¡å‹™åˆ†æ</h3>
        <div class="analysis-content">
            {% if request.user.is_authenticated %}
                <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šåŸºæœ¬è²¡å‹™åˆ†æ + AIåˆ†æã¯åˆ¥ã‚¿ãƒ–ã§è©³ç´°è¡¨ç¤º -->
                <div class="financial-analysis-basic">
                    <p>ã“ã®ä¼æ¥­ã®éå»{{ financial_data|length }}å¹´é–“ã®è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãåˆ†æã§ã™ã€‚
                    {% with latest=financial_data.0.data oldest=financial_data.last.data %}
                    {% if latest.net_sales and oldest.net_sales %}
                    å£²ä¸Šé«˜ã¯{{ oldest.fiscal_year }}å¹´ã®{{ oldest.net_sales|to_billion|floatformat:1 }}å„„å††ã‹ã‚‰{{ latest.fiscal_year }}å¹´ã®{{ latest.net_sales|to_billion|floatformat:1 }}å„„å††ã¸ã¨æ¨ç§»ã—ã¦ã„ã¾ã™ã€‚
                    {% endif %}
                    {% endwith %}
                    </p>
                    <p><strong>è©³ç´°ãªAIåˆ†æã¯ã€ŒAIä¼æ¥­åˆ†æã€ã‚¿ãƒ–ã§ã”è¦§ã„ãŸã ã‘ã¾ã™ã€‚</strong></p>
                </div>
                
                <!-- ä¼æ¥­æ¦‚è¦ï¼ˆTavilyãƒ™ãƒ¼ã‚¹ï¼‰ -->
                <div class="company-overview-section" id="company-overview-section">
                    <h4>ğŸ“‹ ä¼æ¥­æ¦‚è¦</h4>
                    <div class="company-overview-content">
                        <div class="loading-text">ä¼æ¥­æƒ…å ±ã‚’å–å¾—ä¸­...</div>
                    </div>
                </div>
            {% else %}
                <p>ã“ã®ä¼æ¥­ã®éå»{{ financial_data|length }}å¹´é–“ã®è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãåŸºæœ¬åˆ†æã§ã™ã€‚
                {% with latest=financial_data.0.data oldest=financial_data.last.data %}
                {% if latest.net_sales and oldest.net_sales %}
                å£²ä¸Šé«˜ã¯{{ oldest.fiscal_year }}å¹´ã®{{ oldest.net_sales|to_billion|floatformat:1 }}å„„å††ã‹ã‚‰{{ latest.fiscal_year }}å¹´ã®{{ latest.net_sales|to_billion|floatformat:1 }}å„„å††ã¸ã¨æ¨ç§»ã—ã¦ã„ã¾ã™ã€‚
                {% endif %}
                {% endwith %}
                <strong>è©³ç´°ãªAIåˆ†æã‚’ã”è¦§ã„ãŸã ãã«ã¯ã€ç„¡æ–™ã®ä¼šå“¡ç™»éŒ²ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</strong></p>
                
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>


<!-- AIä¼æ¥­åˆ†æã‚¿ãƒ– -->
<div id="ai-analysis" class="tab-content">
    <h2>AIä¼æ¥­åˆ†æ</h2>
    {% if show_login_prompt %}
        <div class="login-required-section">
            <div class="lock-icon">ğŸ”’</div>
            <h3>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h3>
            <p>AIä¼æ¥­åˆ†æã‚’ã”è¦§ã„ãŸã ãã«ã¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ï¼ˆç„¡æ–™ï¼‰ã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
            <div class="feature-preview">
                <h4>ğŸ¤– ã“ã®æ©Ÿèƒ½ã§åˆ†æã§ãã‚‹ã“ã¨:</h4>
                <ul>
                    <li>Googleã®æœ€æ–°AIæŠ€è¡“ã«ã‚ˆã‚‹æ·±åº¦ã®ã‚ã‚‹ä¼æ¥­åˆ†æ</li>
                    <li>è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ä¼æ¥­ã®å¼·ã¿ã¨èª²é¡Œ</li>
                    <li>å°†æ¥æ€§ã‚„æŠ•è³‡ä¾¡å€¤ã«é–¢ã™ã‚‹ç·åˆçš„ãªè©•ä¾¡</li>
                    <li>æ¥­ç•Œå†…ã§ã®ç«¶äº‰å„ªä½æ€§ã®åˆ†æ</li>
                    <li>çµŒå–¶é™£ã®æˆ¦ç•¥ã‚„äº‹æ¥­å±•é–‹ã«é–¢ã™ã‚‹æ´å¯Ÿ</li>
                </ul>
            </div>
            <div class="login-buttons-detail">
                <a href="{% url 'financial:register' %}" class="btn-primary">ç„¡æ–™ã§æ–°è¦ç™»éŒ²</a>
                <a href="{% url 'financial:login' %}" class="btn-secondary">ãƒ­ã‚°ã‚¤ãƒ³</a>
            </div>
        </div>
    {% else %}
        <!-- AIåˆ†æçµæœã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ -->
        <div class="ai-analysis-content">
            <!-- 3ã‚·ãƒŠãƒªã‚ªäºˆæ¸¬åˆ†æï¼ˆã‚°ãƒ©ãƒ•ï¼‹AIåˆ†æï¼‰ -->
            <div class="analysis-section">
                <h3>ğŸ“Š 3ã‚·ãƒŠãƒªã‚ªäºˆæ¸¬åˆ†æ</h3>
                <div class="prediction-analysis-content">
                    <!-- äºˆæ¸¬åˆ†æçµæœã¯AIåˆ†æã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    <div class="predictions-content">
                        <!-- JavaScriptã«ã‚ˆã‚‹å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                    </div>
                </div>
            </div>
            
            
            <!-- ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°åˆ†æ -->
            <div class="analysis-section">
                <h3>ğŸ¯ ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°åˆ†æ</h3>
                
                <!-- äºŒè»¸åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="positioning-analysis-content">
                    <h4>ğŸ“Š äºŒè»¸åˆ†æï¼ˆæˆé•·æ€§ Ã— å®‰å®šæ€§ï¼‰</h4>
                    <div class="positioning-map-container">
                        <p class="positioning-explanation">ä¼æ¥­ã®æˆé•·æ€§ã¨å®‰å®šæ€§ã‚’åˆ†æä¸­...</p>
                        <div class="positioning-loading">
                            <div class="loading-spinner"></div>
                            <p>äºŒè»¸åˆ†æã‚’å®Ÿè¡Œä¸­ã§ã™...</p>
                        </div>
                    </div>
                    
                    <!-- äºŒè»¸åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div class="positioning-results" style="display: none;">
                        <div class="quadrant-summary">
                            <div class="quadrant-badge">
                                <span class="quadrant-name"></span>
                                <span class="quadrant-description"></span>
                            </div>
                            <div class="scores-container">
                                <div class="score-item">
                                    <span class="score-label">æˆé•·æ€§</span>
                                    <span class="score-value growth-score"></span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">å®‰å®šæ€§</span>
                                    <span class="score-value stability-score"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="positioning-chart-container">
                            <canvas id="positioning-chart" class="positioning-chart"></canvas>
                        </div>
                        
                        <div class="career-advice">
                            <h5>ğŸ’¼ ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h5>
                            <p class="advice-text"></p>
                        </div>
                        
                        <div class="recommendations-section">
                            <h5>ğŸ” åŒã˜ã‚¿ã‚¤ãƒ—ã®ä¼æ¥­</h5>
                            <ul class="recommendations-list"></ul>
                        </div>
                        
                        <div class="detailed-metrics">
                            <h5>ğŸ“ˆ è©³ç´°æŒ‡æ¨™</h5>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <span class="metric-label">å£²ä¸Šé«˜æˆé•·ç‡</span>
                                    <span class="metric-value sales-growth"></span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">å¾“æ¥­å“¡æ•°æˆé•·ç‡</span>
                                    <span class="metric-value employee-growth"></span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">R&Dé›†ç´„åº¦</span>
                                    <span class="metric-value rd-intensity"></span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">è‡ªå·±è³‡æœ¬æ¯”ç‡</span>
                                    <span class="metric-value equity-ratio"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å¾“æ¥ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°åˆ†æï¼ˆèƒŒæ™¯æƒ…å ±ã¨ã—ã¦è¡¨ç¤ºï¼‰ -->
                <div class="clustering-analysis-content">
                    <h4>ğŸ”— è©³ç´°ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°åˆ†æ</h4>
                    
                    <!-- åˆæœŸãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
                    <div class="clustering-loading" style="display: block;">
                        <div class="loading-spinner"></div>
                        <p>ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°åˆ†æã‚’å®Ÿè¡Œä¸­ã§ã™...</p>
                    </div>
                    
                    <!-- å‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°çµæœ -->
                    <div class="clustering-content" style="display: none;">
                        <div class="cluster-summary">
                            <h5 class="cluster-title">åˆ†æä¸­...</h5>
                            <p class="cluster-year">ãƒ‡ãƒ¼ã‚¿å¹´åº¦: åˆ†æä¸­...</p>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="clustering-chart" class="cluster-chart"></canvas>
                        </div>
                        
                        <div class="similar-companies">
                            <h5>åŒã˜ã‚¯ãƒ©ã‚¹ã‚¿ã®ä¼æ¥­</h5>
                            <ul class="similar-companies-list">
                                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                            </ul>
                        </div>
                        
                        <div class="cluster-characteristics">
                            <h5>ã‚¯ãƒ©ã‚¹ã‚¿ã®ç‰¹å¾´</h5>
                            <div class="characteristics-container">
                                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆå¿…è¦æ™‚ï¼‰ -->
                    <div class="clustering-error" style="display: none;">
                        <p>ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°åˆ†æã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>
            
            <!-- ç·æ‹¬ -->
            <div class="analysis-section">
                <h3>ğŸ“ ç·æ‹¬ãƒ»ã‚­ãƒ£ãƒªã‚¢åˆ†æ</h3>
                <div class="summary-analysis">
                    <p class="summary-content">åˆ†æä¸­...</p>
                </div>
            </div>
        </div>
    {% endif %}
</div>


{% endif %}

{% block extra_js %}
<script src="{% static 'core/js/company_detail.js' %}?v={{ timestamp|default:'1.0' }}"></script>
{% endblock %}
{% endblock %}